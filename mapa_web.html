<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Rastreo Avanzado - HereACA</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --sidebar-width: 320px;
            --header-height: 70px;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            color: #333;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100vh;
            transition: margin-left 0.3s ease;
        }

        /* Header Superior */
        #header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow);
            border-bottom: 1px solid #e0e0e0;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--dark-color);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }

        .menu-toggle:hover {
            background: #f0f0f0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            font-size: 20px;
            color: var(--dark-color);
        }

        .logo-icon {
            color: var(--primary-color);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            background: #f8f9fa;
            padding: 8px 15px;
            border-radius: 20px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--success-color);
        }

        .status-dot.offline {
            background-color: var(--error-color);
        }

        .status-dot.connecting {
            background-color: var(--warning-color);
        }

        /* Sidebar / Menú Hamburguesa */
        #sidebar {
            position: fixed;
            top: var(--header-height);
            left: 0;
            width: var(--sidebar-width);
            height: calc(100vh - var(--header-height));
            background: white;
            z-index: 999;
            box-shadow: var(--shadow);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        #sidebar.active {
            transform: translateX(0);
        }

        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .section-title {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 15px;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            background-color: #f8f9fa;
            color: var(--dark-color);
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s ease;
            text-align: left;
        }

        .btn:hover {
            background-color: #e9ecef;
        }

        .btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .btn i {
            font-size: 16px;
            width: 20px;
        }

        /* Panel de Información del Usuario */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .info-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .info-value {
            font-weight: 700;
            font-size: 18px;
            margin: 8px 0;
        }

        .info-label {
            font-size: 12px;
            color: #666;
        }

        .battery-level {
            height: 6px;
            background: #eee;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .battery-fill {
            height: 100%;
            background: var(--success-color);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .battery-fill.warning {
            background: var(--warning-color);
        }

        .battery-fill.danger {
            background: var(--error-color);
        }

        /* Panel de Historial */
        .history-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .history-item {
            padding: 10px;
            border-left: 3px solid var(--primary-color);
            background: #f8f9fa;
            margin-bottom: 8px;
            border-radius: 0 6px 6px 0;
            font-size: 13px;
        }

        .history-time {
            font-size: 11px;
            color: #666;
            margin-bottom: 4px;
        }

        .history-coords {
            font-family: monospace;
        }

        /* Controles Flotantes */
        .floating-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 998;
        }

        .floating-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: none;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: var(--dark-color);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .floating-btn:hover {
            transform: scale(1.1);
            background: var(--primary-color);
            color: white;
        }

        /* Geocerca Visual */
        .geofence-marker {
            background: rgba(52, 152, 219, 0.3);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
        }

        /* Panel de Debug */
        #debug-panel {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 12px;
            z-index: 997;
            box-shadow: var(--shadow);
            max-width: 400px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 12px;
            display: none;
        }

        .debug-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .debug-entry {
            margin-bottom: 5px;
            padding: 3px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .debug-time {
            color: #888;
            margin-right: 8px;
        }

        /* Modo Noche */
        .night-mode {
            filter: invert(1) hue-rotate(180deg);
        }

        /* Modal para crear geocercas */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-weight: 600;
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        /* Notificaciones */
        .notification-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 2000;
            max-width: 350px;
        }

        .notification {
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border-left: 4px solid var(--primary-color);
            animation: slideInRight 0.3s ease;
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.error {
            border-left-color: var(--error-color);
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification-icon {
            font-size: 20px;
            margin-top: 2px;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .notification-message {
            font-size: 14px;
            color: #666;
        }

        .notification-close {
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
            font-size: 16px;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Modal para compartir */
        .share-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 15px 0;
        }

        .share-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .share-option:hover {
            background: #f8f9fa;
        }

        .share-option i {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .share-option.whatsapp i {
            color: #25D366;
        }

        .share-option.telegram i {
            color: #0088cc;
        }

        .share-option.link i {
            color: var(--primary-color);
        }

        .share-option.qr i {
            color: #333;
        }

        .share-link-container {
            display: flex;
            gap: 10px;
            margin: 15px 0;
        }

        .share-link {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background: #f8f9fa;
            font-size: 14px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .copy-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 15px;
            cursor: pointer;
        }

        .qr-code-container {
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        #qr-code {
            max-width: 100%;
            height: auto;
        }

        /* Responsive */
        @media (max-width: 768px) {
            :root {
                --sidebar-width: 100%;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            #debug-panel {
                max-width: calc(100% - 40px);
            }

            .notification-container {
                right: 10px;
                left: 10px;
                max-width: none;
            }
        }

        /* Animaciones */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        .geofence-circle {
            position: absolute;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            background-color: rgba(52, 152, 219, 0.1);
            pointer-events: none;
        }
    </style>
</head>
<body>
<!-- Header Superior -->
<div id="header">
    <div class="header-left">
        <button class="menu-toggle" id="menu-toggle">
            <i class="fas fa-bars"></i>
        </button>
        <div class="logo">
            <i class="fas fa-map-marker-alt logo-icon"></i>
            <span>HereACA Tracker</span>
        </div>
    </div>
    <div class="header-right">
        <div class="status-indicator">
            <div class="status-dot connecting" id="status-dot"></div>
            <span id="status-text">Conectando...</span>
        </div>
    </div>
</div>

<!-- Sidebar / Menú Hamburguesa -->
<div id="sidebar">
    <!-- Sección de Información del Usuario -->
    <div class="sidebar-section">
        <div class="section-title">
            <i class="fas fa-user-circle"></i>
            Información del Usuario
        </div>
        <div class="info-grid">
            <div class="info-card">
                <i class="fas fa-user" style="color: #3498db;"></i>
                <div class="info-value" id="user-id">-</div>
                <div class="info-label">Usuario</div>
            </div>

            <div class="info-card">
                <i class="fas fa-mobile-alt" style="color: #9b59b6;"></i>
                <div class="info-value" id="device-info">-</div>
                <div class="info-label">Dispositivo</div>
            </div>

            <div class="info-card">
                <i class="fas fa-battery-half" style="color: #2ecc71;"></i>
                <div class="info-value" id="battery-level">-</div>
                <div class="info-label">Batería</div>
                <div class="battery-level">
                    <div class="battery-fill" id="battery-fill" style="width: 0%"></div>
                </div>
            </div>

            <div class="info-card">
                <i class="fas fa-bullseye" style="color: #e74c3c;"></i>
                <div class="info-value" id="accuracy">-</div>
                <div class="info-label">Precisión</div>
            </div>
        </div>
        <div style="margin-top: 15px; font-size: 12px; color: #666; text-align: center;">
            <i class="fas fa-clock"></i> Actualizado: <span id="last-update">-</span>
        </div>
    </div>

    <!-- Sección de Compartir Ubicación -->
    <div class="sidebar-section">
        <div class="section-title">
            <i class="fas fa-share-alt"></i>
            Compartir Mi Ubicación
        </div>
        <div class="btn-group">
            <button class="btn" id="btn-share-location">
                <i class="fas fa-share"></i>
                <div>
                    <div>Compartir Enlace</div>
                    <small>Generar enlace de rastreo</small>
                </div>
            </button>
            <button class="btn" id="btn-generate-qr">
                <i class="fas fa-qrcode"></i>
                <div>
                    <div>Código QR</div>
                    <small>Para compartir fácilmente</small>
                </div>
            </button>
        </div>
    </div>

    <!-- Sección de Modos de Visualización -->
    <div class="sidebar-section">
        <div class="section-title">
            <i class="fas fa-map-marked-alt"></i>
            Modo de Visualización
        </div>
        <div class="btn-group">
            <button class="btn active" id="btn-live">
                <i class="fas fa-circle"></i>
                <div>
                    <div>Tiempo Real</div>
                    <small>Seguimiento en vivo</small>
                </div>
            </button>
            <button class="btn" id="btn-route">
                <i class="fas fa-route"></i>
                <div>
                    <div>Ver Ruta</div>
                    <small>Historial de recorrido</small>
                </div>
            </button>
            <button class="btn" id="btn-history">
                <i class="fas fa-history"></i>
                <div>
                    <div>Historial</div>
                    <small>Ubicaciones anteriores</small>
                </div>
            </button>
        </div>
    </div>

    <!-- Sección de Geocercas -->
    <div class="sidebar-section">
        <div class="section-title">
            <i class="fas fa-draw-polygon"></i>
            Geocercas
        </div>
        <div class="btn-group">
            <button class="btn" id="btn-add-geofence">
                <i class="fas fa-plus-circle"></i>
                <div>
                    <div>Crear Geocerca</div>
                    <small>En ubicación actual</small>
                </div>
            </button>
            <button class="btn" id="btn-clear-geofences">
                <i class="fas fa-trash"></i>
                <div>
                    <div>Limpiar Geocercas</div>
                    <small>Eliminar todas</small>
                </div>
            </button>
        </div>
    </div>

    <!-- Sección de Historial -->
    <div class="sidebar-section">
        <div class="section-title">
            <i class="fas fa-list-alt"></i>
            Historial Reciente
        </div>
        <div class="history-list" id="history-list">
            <!-- Los elementos de historial se insertarán aquí -->
        </div>
        <button class="btn" id="btn-clear-history" style="margin-top: 10px;">
            <i class="fas fa-trash"></i> Limpiar Historial
        </button>
    </div>

    <!-- Sección de Configuración -->
    <div class="sidebar-section">
        <div class="section-title">
            <i class="fas fa-cog"></i>
            Configuración
        </div>
        <div class="btn-group">
            <button class="btn" id="btn-night-mode">
                <i class="fas fa-moon"></i>
                <div>
                    <div>Modo Noche</div>
                    <small>Alternar tema oscuro</small>
                </div>
            </button>
            <button class="btn" id="btn-fullscreen">
                <i class="fas fa-expand"></i>
                <div>
                    <div>Pantalla Completa</div>
                    <small>Maximizar visualización</small>
                </div>
            </button>
            <button class="btn" id="btn-debug">
                <i class="fas fa-terminal"></i>
                <div>
                    <div>Consola Debug</div>
                    <small>Mostrar/Ocultar logs</small>
                </div>
            </button>
        </div>
    </div>
</div>

<!-- Mapa -->
<div id="map"></div>

<!-- Controles Flotantes -->
<div class="floating-controls">
    <button class="floating-btn" id="btn-center-map" title="Centrar en ubicación">
        <i class="fas fa-crosshairs"></i>
    </button>
    <button class="floating-btn" id="btn-zoom-in" title="Acercar">
        <i class="fas fa-plus"></i>
    </button>
    <button class="floating-btn" id="btn-zoom-out" title="Alejar">
        <i class="fas fa-minus"></i>
    </button>
</div>

<!-- Panel de Debug -->
<div id="debug-panel">
    <div class="debug-header">
        <div>Consola de Depuración</div>
        <button class="btn" id="btn-clear-logs" style="padding: 5px 10px; font-size: 12px;">
            <i class="fas fa-trash"></i> Limpiar
        </button>
    </div>
    <div id="debug-logs"></div>
</div>

<!-- Modal para crear geocercas -->
<div id="geofence-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Crear Geocerca</div>
            <button class="close-modal" id="close-geofence-modal">&times;</button>
        </div>
        <div class="form-group">
            <label class="form-label" for="geofence-radius">Radio de la geocerca (metros)</label>
            <input type="number" id="geofence-radius" class="form-input" min="10" max="5000" value="200">
        </div>
        <div class="form-group">
            <label class="form-label" for="geofence-name">Nombre de la geocerca (opcional)</label>
            <input type="text" id="geofence-name" class="form-input" placeholder="Mi geocerca">
        </div>
        <div class="form-actions">
            <button class="btn-secondary" id="cancel-geofence">Cancelar</button>
            <button class="btn-primary" id="save-geofence">Crear Geocerca</button>
        </div>
    </div>
</div>

<!-- Modal para compartir ubicación -->
<div id="share-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Compartir Mi Ubicación</div>
            <button class="close-modal" id="close-share-modal">&times;</button>
        </div>

        <div class="share-options">
            <div class="share-option whatsapp" id="share-whatsapp">
                <i class="fab fa-whatsapp"></i>
                <div>
                    <div>Compartir por WhatsApp</div>
                    <small>Enviar enlace por WhatsApp</small>
                </div>
            </div>

            <div class="share-option telegram" id="share-telegram">
                <i class="fab fa-telegram"></i>
                <div>
                    <div>Compartir por Telegram</div>
                    <small>Enviar enlace por Telegram</small>
                </div>
            </div>

            <div class="share-option link" id="share-link">
                <i class="fas fa-link"></i>
                <div>
                    <div>Copiar Enlace</div>
                    <small>Copiar URL al portapapeles</small>
                </div>
            </div>

            <div class="share-option qr" id="share-qr">
                <i class="fas fa-qrcode"></i>
                <div>
                    <div>Generar Código QR</div>
                    <small>Mostrar código QR para escanear</small>
                </div>
            </div>
        </div>

        <div class="share-link-container" id="link-container" style="display: none;">
            <input type="text" class="share-link" id="share-url" readonly>
            <button class="copy-btn" id="copy-link">
                <i class="fas fa-copy"></i>
            </button>
        </div>

        <div class="qr-code-container" id="qr-container" style="display: none;">
            <canvas id="qr-code"></canvas>
            <p style="margin-top: 10px; font-size: 14px;">Escanea este código para ver mi ubicación en tiempo real</p>
        </div>
    </div>
</div>

<!-- Contenedor de notificaciones -->
<div class="notification-container" id="notification-container"></div>

<script>
    // ========== CONFIGURACIÓN ==========
    const firebaseConfig = {
        apiKey: "AIzaSyCZz9O5ti5gylczX58X4Ni-WxsliV3m54Y",
        authDomain: "hereaca.firebaseapp.com",
        projectId: "hereaca",
        storageBucket: "hereaca.firebasestorage.app",
        messagingSenderId: "554391595579",
        appId: "1:554391595579:android:aa94be82ce48a0b39f0a1e"
    };

    // ========== INICIALIZACIÓN ==========
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    mapboxgl.accessToken = 'pk.eyJ1IjoiY2VjaWxpYXRhcmlmYTAwIiwiYSI6ImNtZnU2NHp2ZTExdTYyanBvNHVrc2hwcTMifQ.tZj5j0FWDcRHNkzYU-t0SQ';

    let map;
    let marker = null;
    let isFirstLoad = true;
    let currentMode = 'live';
    let routeCoordinates = [];
    let geofences = [];
    let locationHistory = [];
    let isNightMode = false;
    let isFullscreen = false;
    let isSidebarOpen = false;
    let locationBuffer = [];
    const LOCATION_BUFFER_SIZE = 5;
    let shareUrl = '';
    let currentUserId = '';

    // ========== FUNCIONES DE NOTIFICACIÓN ==========
    function showNotification(title, message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;

        let icon = 'info-circle';
        if (type === 'warning') icon = 'exclamation-triangle';
        if (type === 'error') icon = 'exclamation-circle';
        if (type === 'success') icon = 'check-circle';

        notification.innerHTML = `
            <div class="notification-icon">
                <i class="fas fa-${icon}"></i>
            </div>
            <div class="notification-content">
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            </div>
            <button class="notification-close">
                <i class="fas fa-times"></i>
            </button>
        `;

        container.appendChild(notification);

        // Auto-remover después de 5 segundos
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }
        }, 5000);

        // Cerrar manualmente
        notification.querySelector('.notification-close').addEventListener('click', () => {
            notification.style.animation = 'slideInRight 0.3s ease reverse';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        });
    }

    // ========== FUNCIONES DE DEBUG ==========
    function addDebugLog(message, type = 'info') {
        const logsDiv = document.getElementById('debug-logs');
        const logEntry = document.createElement('div');
        logEntry.className = 'debug-entry';

        const time = new Date().toLocaleTimeString();
        logEntry.innerHTML = `<span class="debug-time">[${time}]</span> ${message}`;

        if (type === 'error') {
            logEntry.style.color = 'var(--error-color)';
        } else if (type === 'success') {
            logEntry.style.color = 'var(--success-color)';
        } else if (type === 'warning') {
            logEntry.style.color = 'var(--warning-color)';
        }

        logsDiv.appendChild(logEntry);
        logsDiv.scrollTop = logsDiv.scrollHeight;
        console.log(`[${type.toUpperCase()}] ${message}`);
    }

    function updateStatus(status, isOnline = true) {
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');

        if (isOnline) {
            statusDot.className = 'status-dot';
            statusText.textContent = status;
        } else {
            statusDot.className = 'status-dot offline';
            statusText.textContent = status;
        }
    }

    // ========== MANEJO DEL SIDEBAR ==========
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const map = document.getElementById('map');

        isSidebarOpen = !isSidebarOpen;
        sidebar.classList.toggle('active', isSidebarOpen);

        if (isSidebarOpen) {
            map.style.marginLeft = 'var(--sidebar-width)';
        } else {
            map.style.marginLeft = '0';
        }
    }

    // ========== FUNCIONES PARA COMPARTIR ==========
    function generateShareUrl() {
        // Crear un ID único para este dispositivo
        if (!currentUserId) {
            // Generar un ID único o usar uno existente
            currentUserId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('trackerUserId', currentUserId);
        }

        // Crear URL con parámetro de usuario
        const baseUrl = window.location.href.split('?')[0];
        shareUrl = `${baseUrl}?track=${currentUserId}`;

        // Actualizar el campo de URL en el modal
        const shareUrlInput = document.getElementById('share-url');
        if (shareUrlInput) {
            shareUrlInput.value = shareUrl;
        }

        return shareUrl;
    }

    function showShareModal() {
        generateShareUrl();
        const modal = document.getElementById('share-modal');
        modal.style.display = 'flex';

        // Ocultar contenedores adicionales
        document.getElementById('link-container').style.display = 'none';
        document.getElementById('qr-container').style.display = 'none';
    }

    function hideShareModal() {
        const modal = document.getElementById('share-modal');
        modal.style.display = 'none';
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            showNotification('Enlace copiado', 'El enlace se ha copiado al portapapeles', 'success');
        }).catch(err => {
            console.error('Error al copiar: ', err);
            // Fallback para navegadores antiguos
            const textArea = document.createElement('textarea');
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showNotification('Enlace copiado', 'El enlace se ha copiado al portapapeles', 'success');
        });
    }

    function shareOnWhatsApp() {
        const message = `¡Hola! Puedes ver mi ubicación en tiempo real aquí: ${shareUrl}`;
        const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }

    function shareOnTelegram() {
        const message = `¡Hola! Puedes ver mi ubicación en tiempo real aquí: ${shareUrl}`;
        const url = `https://t.me/share/url?url=${encodeURIComponent(shareUrl)}&text=${encodeURIComponent(message)}`;
        window.open(url, '_blank');
    }

    function generateQRCode() {
        const canvas = document.getElementById('qr-code');
        const container = document.getElementById('qr-container');

        // Mostrar contenedor QR
        document.getElementById('link-container').style.display = 'none';
        container.style.display = 'block';

        // Limpiar canvas
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Generar QR code
        QRCode.toCanvas(canvas, shareUrl, {
            width: 200,
            margin: 2,
            color: {
                dark: '#000000',
                light: '#FFFFFF'
            }
        }, function(error) {
            if (error) {
                console.error('Error generando QR:', error);
                // Fallback simple si hay error
                ctx.fillStyle = '#000';
                ctx.fillRect(50, 50, 100, 100);
                ctx.fillStyle = '#fff';
                ctx.fillRect(70, 70, 60, 60);
                ctx.fillStyle = '#000';
                ctx.fillRect(90, 90, 20, 20);

                ctx.fillStyle = '#000';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Escanea para ver mi ubicación', 100, 180);
            }
        });
    }

    // ========== FIRESTORE LISTENER ==========
    function initializeFirestoreListener() {
        updateStatus('Conectando...', false);
        addDebugLog('Iniciando listener de Firestore...', 'info');

        db.collection("ubicaciones")
            .onSnapshot({
                next: (snapshot) => {
                    addDebugLog(`Datos recibidos: ${snapshot.size} documentos`, 'success');
                    updateStatus('Conectado', true);

                    let changesDetected = false;

                    snapshot.docChanges().forEach((change) => {
                        const docId = change.doc.id;
                        const data = change.doc.data();

                        addDebugLog(`Cambio: ${change.type} - Documento: ${docId}`, 'success');

                        if (data.latitud !== undefined && data.longitud !== undefined) {
                            addDebugLog(`Coordenadas válidas: ${data.latitud}, ${data.longitud}`, 'success');

                            // Guardar ID de usuario para compartir
                            if (data.idUsuario && !currentUserId) {
                                currentUserId = data.idUsuario;
                                generateShareUrl();
                            }

                            processLocationUpdate(data.latitud, data.longitud, data);
                            changesDetected = true;
                        } else {
                            addDebugLog('Datos incompletos en documento', 'warning');
                        }
                    });

                    if (!changesDetected && snapshot.size > 0) {
                        const latestDoc = snapshot.docs[snapshot.docs.length - 1];
                        const data = latestDoc.data();
                        if (data.latitud && data.longitud) {
                            addDebugLog('Procesando última ubicación disponible', 'info');
                            processLocationUpdate(data.latitud, data.longitud, data);
                        }
                    }
                },
                error: (error) => {
                    addDebugLog(`Error Firestore: ${error.message}`, 'error');
                    updateStatus('Error de conexión', false);
                    setTimeout(initializeFirestoreListener, 5000);
                }
            });
    }

    // ========== PROCESAMIENTO DE UBICACIÓN ==========
    function processLocationUpdate(lat, lng, data) {
        addDebugLog(`Procesando ubicación: ${lat}, ${lng}`, 'success');

        const latitude = typeof lat === 'string' ? parseFloat(lat) : lat;
        const longitude = typeof lng === 'string' ? parseFloat(lng) : lng;

        if (isNaN(latitude) || isNaN(longitude)) {
            addDebugLog('Coordenadas no válidas', 'error');
            return;
        }

        addToHistory(latitude, longitude, data);

        if (currentMode === 'route') {
            addToRoute(latitude, longitude);
        }

        updateMap(latitude, longitude, data);
        updateUserInfo(data);
        checkGeofences(latitude, longitude);
    }

    // ========== GESTIÓN DE RUTAS ==========
    function addToRoute(lat, lng) {
        routeCoordinates.push([lng, lat]);
        drawRoute();
    }

    function drawRoute() {
        if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }

        if (routeCoordinates.length > 1) {
            map.addSource('route', {
                'type': 'geojson',
                'data': {
                    'type': 'Feature',
                    'properties': {},
                    'geometry': {
                        'type': 'LineString',
                        'coordinates': routeCoordinates
                    }
                }
            });

            map.addLayer({
                'id': 'route',
                'type': 'line',
                'source': 'route',
                'layout': {
                    'line-join': 'round',
                    'line-cap': 'round'
                },
                'paint': {
                    'line-color': '#3887be',
                    'line-width': 5,
                    'line-opacity': 0.75
                }
            });
        }
    }

    function clearRoute() {
        routeCoordinates = [];
        if (map.getSource('route')) {
            map.removeLayer('route');
            map.removeSource('route');
        }
    }

    // ========== GESTIÓN DE HISTORIAL ==========
    function addToHistory(lat, lng, data) {
        const historyItem = {
            lat: lat,
            lng: lng,
            timestamp: new Date(),
            data: data
        };

        locationHistory.unshift(historyItem);

        if (locationHistory.length > 50) {
            locationHistory.pop();
        }

        updateHistoryDisplay();
    }

    function updateHistoryDisplay() {
        const historyList = document.getElementById('history-list');
        historyList.innerHTML = '';

        locationHistory.slice(0, 10).forEach(item => {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';

            const time = item.timestamp.toLocaleTimeString();
            const coords = `${item.lat.toFixed(4)}, ${item.lng.toFixed(4)}`;

            historyItem.innerHTML = `
                <div class="history-time">${time}</div>
                <div class="history-coords">${coords}</div>
            `;

            historyList.appendChild(historyItem);
        });
    }

    function clearHistory() {
        locationHistory = [];
        updateHistoryDisplay();
        addDebugLog('Historial limpiado', 'info');
    }

    // ========== GEOCERCAS ==========
    function showGeofenceModal() {
        const modal = document.getElementById('geofence-modal');
        modal.style.display = 'flex';
    }

    function hideGeofenceModal() {
        const modal = document.getElementById('geofence-modal');
        modal.style.display = 'none';
    }

    function addGeofence(lat, lng, radius = 100, name = 'Geocerca') {
        const geofence = {
            lat: lat,
            lng: lng,
            radius: radius,
            name: name,
            id: 'geofence-' + Date.now()
        };

        geofences.push(geofence);
        drawGeofence(geofence);
        addDebugLog(`Geocerca "${name}" creada en ${lat.toFixed(4)}, ${lng.toFixed(4)} con radio ${radius}m`, 'success');
        showNotification('Geocerca creada', `"${name}" creada con radio ${radius}m`, 'success');
    }

    function drawGeofence(geofence) {
        const el = document.createElement('div');
        el.className = 'geofence-marker';
        el.style.width = '30px';
        el.style.height = '30px';

        new mapboxgl.Marker(el)
            .setLngLat([geofence.lng, geofence.lat])
            .setPopup(new mapboxgl.Popup().setHTML(`
                <div style="padding: 10px;">
                    <strong>${geofence.name}</strong><br>
                    Radio: ${geofence.radius}m
                </div>
            `))
            .addTo(map);
    }

    function checkGeofences(lat, lng) {
        geofences.forEach(geofence => {
            const distance = calculateDistance(lat, lng, geofence.lat, geofence.lng);
            if (distance <= geofence.radius) {
                addDebugLog(`Usuario entró en geocerca "${geofence.name}" (distancia: ${distance.toFixed(1)}m)`, 'warning');
                showNotification(
                    'Entrada en geocerca',
                    `El usuario entró en "${geofence.name}" (a ${distance.toFixed(1)}m del centro)`,
                    'warning'
                );
            }
        });
    }

    function calculateDistance(lat1, lng1, lat2, lng2) {
        const R = 6371000;
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLng = (lng2 - lng1) * Math.PI / 180;
        const a =
            Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLng/2) * Math.sin(dLng/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    function clearGeofences() {
        geofences = [];
        addDebugLog('Geocercas eliminadas', 'info');
        showNotification('Geocercas eliminadas', 'Todas las geocercas han sido eliminadas', 'info');
    }

    // ========== ACTUALIZACIÓN DEL MAPA ==========
    function updateMap(lat, lng, data) {
        addDebugLog(`Actualizando mapa: ${lat}, ${lng}`, 'success');

        if (!map) {
            initializeMap(lng, lat);
        }

        if (!marker) {
            marker = new mapboxgl.Marker({
                color: '#FF0000',
                draggable: false
            })
            .setLngLat([lng, lat])
            .setPopup(new mapboxgl.Popup().setHTML(`
                <div style="padding: 10px; min-width: 200px;">
                    <strong>Ubicación en Tiempo Real</strong><br><br>
                    <strong>Usuario:</strong> ${data.idUsuario ? data.idUsuario.substring(0, 8) + '...' : 'Invitado'}<br>
                    <strong>Dispositivo:</strong> ${data.marcaDispositivo || 'N/A'}<br>
                    <strong>Batería:</strong> ${data.nivelBateria || 'N/A'}%<br>
                    <strong>Precisión:</strong> ${data.precision || 'N/A'}m<br>
                    <strong>Coordenadas:</strong><br>${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                    <strong>Actualizado:</strong> ${new Date().toLocaleTimeString()}
                </div>
            `))
            .addTo(map);

            addDebugLog('Marcador creado en el mapa', 'success');
        } else {
            marker.setLngLat([lng, lat]);
        }

        if (isFirstLoad) {
            map.flyTo({
                center: [lng, lat],
                zoom: 15,
                duration: 2000
            });
            isFirstLoad = false;
            addDebugLog('Mapa centrado en ubicación', 'success');
        }
    }

    // ========== ACTUALIZAR INFORMACIÓN DEL USUARIO ==========
    function updateUserInfo(data) {
        document.getElementById('user-id').textContent = data.idUsuario ?
            data.idUsuario.substring(0, 8) + '...' : 'Invitado';
        document.getElementById('device-info').textContent = data.marcaDispositivo || 'N/A';

        const batteryLevel = data.nivelBateria || 0;
        document.getElementById('battery-level').textContent = `${batteryLevel}%`;
        const batteryFill = document.getElementById('battery-fill');
        batteryFill.style.width = `${batteryLevel}%`;

        if (batteryLevel < 20) {
            batteryFill.className = 'battery-fill danger';
        } else if (batteryLevel < 50) {
            batteryFill.className = 'battery-fill warning';
        } else {
            batteryFill.className = 'battery-fill';
        }

        document.getElementById('accuracy').textContent = data.precision ?
            `${data.precision}m` : 'N/A';
        document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
    }

    // ========== INICIALIZACIÓN DEL MAPA ==========
    function initializeMap(lng, lat) {
        addDebugLog('Inicializando mapa...', 'info');

        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            center: [lng || -68.119, lat || -16.503],
            zoom: 10
        });

        map.on('load', () => {
            addDebugLog('Mapa cargado correctamente', 'success');

            // Inicializar listener de Firestore
            setTimeout(() => {
                initializeFirestoreListener();
            }, 1000);
        });

        map.on('click', (e) => {
            const { lng, lat } = e.lngLat;
            addDebugLog(`Clic en mapa: ${lat.toFixed(6)}, ${lng.toFixed(6)}`, 'info');
        });

        map.on('error', (e) => {
            addDebugLog(`Error del mapa: ${e.error}`, 'error');
        });
    }

    // ========== MANEJO DE EVENTOS ==========
    document.getElementById('menu-toggle').addEventListener('click', toggleSidebar);

    // Botones de compartir
    document.getElementById('btn-share-location').addEventListener('click', showShareModal);
    document.getElementById('btn-generate-qr').addEventListener('click', function() {
        showShareModal();
        generateQRCode();
    });

    // Opciones de compartir
    document.getElementById('share-whatsapp').addEventListener('click', shareOnWhatsApp);
    document.getElementById('share-telegram').addEventListener('click', shareOnTelegram);
    document.getElementById('share-link').addEventListener('click', function() {
        document.getElementById('link-container').style.display = 'flex';
        document.getElementById('qr-container').style.display = 'none';
    });
    document.getElementById('share-qr').addEventListener('click', generateQRCode);
    document.getElementById('copy-link').addEventListener('click', function() {
        copyToClipboard(shareUrl);
    });

    // Cerrar modales
    document.getElementById('close-share-modal').addEventListener('click', hideShareModal);

    document.getElementById('btn-live').addEventListener('click', function() {
        setActiveButton('btn-live');
        currentMode = 'live';
        clearRoute();
        addDebugLog('Modo cambiado: Tiempo Real', 'info');
    });

    document.getElementById('btn-route').addEventListener('click', function() {
        setActiveButton('btn-route');
        currentMode = 'route';
        addDebugLog('Modo cambiado: Visualizar Ruta', 'info');
    });

    document.getElementById('btn-history').addEventListener('click', function() {
        setActiveButton('btn-history');
        currentMode = 'history';
        addDebugLog('Modo cambiado: Ver Historial', 'info');
    });

    document.getElementById('btn-add-geofence').addEventListener('click', function() {
        if (map && marker) {
            showGeofenceModal();
        } else {
            addDebugLog('No hay ubicación actual para crear geocerca', 'warning');
            showNotification('Error', 'No hay ubicación actual para crear geocerca', 'error');
        }
    });

    document.getElementById('save-geofence').addEventListener('click', function() {
        const radius = parseInt(document.getElementById('geofence-radius').value);
        const name = document.getElementById('geofence-name').value || 'Geocerca sin nombre';

        if (radius && radius > 0 && marker) {
            const lngLat = marker.getLngLat();
            addGeofence(lngLat.lat, lngLat.lng, radius, name);
            hideGeofenceModal();

            // Resetear formulario
            document.getElementById('geofence-radius').value = '200';
            document.getElementById('geofence-name').value = '';
        } else {
            showNotification('Error', 'Por favor ingresa un radio válido', 'error');
        }
    });

    document.getElementById('cancel-geofence').addEventListener('click', hideGeofenceModal);
    document.getElementById('close-geofence-modal').addEventListener('click', hideGeofenceModal);

    document.getElementById('btn-clear-geofences').addEventListener('click', clearGeofences);

    document.getElementById('btn-night-mode').addEventListener('click', function() {
        isNightMode = !isNightMode;
        document.body.classList.toggle('night-mode', isNightMode);
        addDebugLog(`Modo noche ${isNightMode ? 'activado' : 'desactivado'}`, 'info');
    });

    document.getElementById('btn-fullscreen').addEventListener('click', function() {
        if (!isFullscreen) {
            document.documentElement.requestFullscreen();
            isFullscreen = true;
        } else {
            document.exitFullscreen();
            isFullscreen = false;
        }
    });

    document.getElementById('btn-debug').addEventListener('click', function() {
        const debugPanel = document.getElementById('debug-panel');
        debugPanel.style.display = debugPanel.style.display === 'block' ? 'none' : 'block';
    });

    document.getElementById('btn-clear-history').addEventListener('click', clearHistory);

    document.getElementById('btn-clear-logs').addEventListener('click', function() {
        document.getElementById('debug-logs').innerHTML = '';
    });

    document.getElementById('btn-center-map').addEventListener('click', function() {
        if (marker) {
            const lngLat = marker.getLngLat();
            map.flyTo({
                center: [lngLat.lng, lngLat.lat],
                zoom: 15,
                duration: 1000
            });
            addDebugLog('Mapa centrado en ubicación actual', 'info');
        }
    });

    document.getElementById('btn-zoom-in').addEventListener('click', function() {
        map.zoomIn();
    });

    document.getElementById('btn-zoom-out').addEventListener('click', function() {
        map.zoomOut();
    });

    function setActiveButton(activeId) {
        document.querySelectorAll('.btn').forEach(btn => {
            btn.classList.remove('active');
        });
        document.getElementById(activeId).classList.add('active');
    }

    // ========== INICIALIZACIÓN DE LA APLICACIÓN ==========
    function initializeApp() {
        addDebugLog('Iniciando aplicación de rastreo avanzado...', 'info');
        updateStatus('Iniciando...', false);

        // Generar URL de compartir
        generateShareUrl();

        initializeMap();
    }

    // ========== INICIAR TODO ==========
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>